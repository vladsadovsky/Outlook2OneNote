# AI Coding Agent Instructions for Outlook2OneNote

## Architecture Overview

This is an **Office Add-in for Outlook** that exports email threads to OneNote using **PKCE OAuth 2.0** authentication. The project follows a **modular service architecture** with strict separation between UI, authentication, and business logic.

### Key Architectural Patterns

**Service Module Pattern**: Core functionality is split into specialized services:
- `src/common/pkce-auth.js` - PKCE OAuth 2.0 authentication with popup flow
- `src/taskpane/onenote-service.js` - OneNote Graph API integration 
- `src/taskpane/email-service.js` - Email thread extraction via Microsoft Graph API (no fallbacks)
- `src/common/app-state.js` - Global state management for selected notebooks

**Conditional Compilation**: Uses webpack `DefinePlugin` to create development vs production builds:
```javascript
if (__DEV__) {
  // Debug features only - completely removed in production
  window.dumpThread = dumpThread;
}
```

**Authentication Cascade**: Implements multiple authentication strategies but email data access is Graph API only:
1. PKCE popup-based OAuth flow (primary)
2. Office.js SSO token (`Office.context.auth.getAccessTokenAsync`)  
3. Mock data (development testing)
4. **Email/conversation data**: Microsoft Graph API exclusively - no EWS or Office.js fallbacks

## Critical Development Workflows

### Environment Setup
1. **Always run**: `npm run validate-env` before development
2. **Environment file**: Copy `.env-template` to `.env` and configure Azure AD settings
3. **Azure AD Setup**: Redirect URI must exactly match: `https://localhost:3000/src/auth/callback`

### Development Commands
```bash
npm run dev-server    # Development with debug features enabled
npm run build         # Production build (strips debug code)  
npm run debug-pkce    # Interactive PKCE flow testing
```

### Office Add-in Debugging
- **VS Code**: Use "Launch Edge against localhost (Office Add-in)" configuration
- **Sideloading**: Outlook Web → Settings → Add-ins → Upload custom add-in
- **Source Maps**: Development uses `eval-source-map`, production uses `source-map`
- **HTTPS Required**: Self-signed certs generated by `office-addin-dev-certs`

## Project-Specific Conventions

### Import/Export Patterns
- **ES6 modules only** - no CommonJS in source files
- **Service exports**: Always export functions individually, not as default objects
- **Config imports**: Environment config loaded through `env-config.js` abstraction

### Error Handling Strategy
- **Console logging**: Prefixed with `"Outlook2OneNote::[module]::[function]"`
- **User feedback**: UI updates via DOM manipulation in `insertAt` elements
- **Authentication errors**: Always provide fallback data for development

### Authentication Implementation
- **Token storage**: Uses `sessionStorage` for security (cleared on tab close)
- **PKCE flow**: Popup-based with parent-child window messaging via `postMessage`
- **Graph API calls**: Always include `Accept: application/json` header

## Integration Points & Dependencies

### Office.js Integration
- **Entry point**: `Office.onReady()` in `taskpane.js`
- **Host validation**: Check `info.host === Office.HostType.Outlook`
- **Mailbox API**: Uses `Office.context.mailbox.item` for email thread access

### Microsoft Graph API Integration
- **Email data access**: Uses Microsoft Graph API exclusively for conversation/thread data
- **No fallback methods**: EWS, Office.js callbacks, and other fallback mechanisms removed
- **Authentication dependency**: All Graph API calls require valid PKCE access tokens
- **Conversation endpoint**: `/me/messages?$filter=conversationId eq '{id}'` for thread retrieval
- **Error handling**: Provides specific Graph API error messages (401, 403, 429 handling)

### OneNote API Integration  
- **Base URL**: `https://graph.microsoft.com/v1.0`
- **Notebooks**: `/me/onenote/notebooks` endpoint
- **Authentication**: Bearer token in Authorization header
- **Scopes**: `Notes.ReadWrite`, `Notes.Read`, `Mail.Read`, `User.Read`

### Webpack Configuration
- **Manifest transformation**: Automatically replaces `localhost` URLs for production
- **Callback routing**: `historyApiFallback` rewrites `/src/auth/callback` to serve `callback.html`
- **Asset handling**: Icons and assets copied to `assets/` directory

## Key Files to Understand

- `src/common/pkce-auth.js` - Core authentication logic, 754 lines of PKCE implementation
- `src/taskpane/taskpane.js` - Main entry point with Office.js initialization
- `manifest.xml` - Office Add-in configuration with Azure AD WebApplicationInfo
- `webpack.config.js` - Build configuration with conditional URL replacement
- `.env` - Environment configuration (never commit this file)

## Development Testing

### Authentication Flow Model - Microsoft "Save to OneNote" Pattern

**Follow Microsoft's built-in "Save to OneNote" Add-in as the exact reference model**:

1. **First-time user experience**: 
   - User opens taskpane for the first time
   - Authentication popup appears automatically requesting Microsoft account credentials
   - After login, authorization consent screen shows permissions for both Outlook and OneNote access
   - User grants permissions and popup closes
   - Taskpane immediately shows available notebooks (seamless transition)

2. **Subsequent uses**:
   - No authentication prompts (tokens cached)
   - Direct access to OneNote functionality
   - Automatic token refresh if needed

3. **Implementation requirements**:
   - **Popup-based authentication** (not redirect-based)
   - **Combined consent screen** showing both Mail.Read and Notes.ReadWrite permissions
   - **Immediate functionality** after consent (no additional setup steps)
   - **Persistent authentication** across sessions until token expires
   - **Graceful re-authentication** if tokens become invalid

4. **User expectations**:
   - Same behavior in Outlook Web and Outlook Desktop New
   - No difference in authentication flow between platforms
   - Standard Microsoft authentication UI/UX patterns
   - Professional, integrated experience matching built-in Office Add-ins

### PKCE Authentication Flow
1. Click "Choose Notebook" → popup opens with Azure AD login
2. Successful auth redirects to `/src/auth/callback` 
3. Callback page exchanges code for token and closes popup
4. Parent window receives `postMessage` with notebooks data

### Mock Data Fallback
- Development builds always provide mock notebooks if auth fails
- Look for `"Test Notebook (Mock"` entries in notebook lists
- Production builds fail gracefully with error messages

### Graph API-Only Data Access Policy
- **Email/conversation data**: Microsoft Graph API exclusively - never use EWS or Office.js callbacks
- **Required scope**: `Mail.Read` must be included in Azure AD app registration
- **Authentication**: All email data access requires valid PKCE access tokens
- **No fallback methods**: Do not implement EWS, `makeEwsRequestAsync`, or `getCallbackTokenAsync` fallbacks
- **Error handling**: Provide clear Graph API error messages instead of attempting fallback methods

### Microsoft Authentication UX Requirements
- **Model after "Save to OneNote"**: Follow Microsoft's built-in Add-in authentication patterns exactly
- **Popup authentication**: Never use redirect-based flows that navigate away from Outlook
- **Combined permissions**: Single consent screen for both Mail.Read and Notes.ReadWrite
- **Immediate functionality**: User should access notebooks immediately after granting consent
- **Cross-platform consistency**: Identical behavior in Outlook Web and Desktop New
- **Standard Microsoft UI**: Use official Microsoft authentication dialogs and styling

### Debug Features
- `DumpThread` button visible only when `__DEV__ === true`
- Exposes detailed email thread analysis for conversation debugging
- Console logs prefixed with module names for easy filtering
